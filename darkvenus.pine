//@version=5
strategy("Dark Venus - Simplified", overlay=true, pyramiding=1, initial_capital=10000, default_qty_type=strategy.percent_of_equity, default_qty_value=10, commission_type=strategy.commission.percent, commission_value=0.1)

// ========================================
// 1. DIRECTION DE TRADING
// ========================================
direction_group = "═══ Direction de Trading ═══"
trade_direction = input.string("Both", "Direction", options=["Long Only", "Short Only", "Both"], group=direction_group, tooltip="Choisir si vous voulez trader uniquement les Longs, les Shorts, ou les deux")

// ========================================
// 2. BOLLINGER BANDS
// ========================================
bb_group = "═══ Bollinger Bands ═══"
bb_strategy = input.string("Sell Above and Buy Below", "BB Strategy", options=["Sell Above and Buy Below", "Buy Above and Sell Below"], group=bb_group)
bb_period = input.int(20, "BB Period", minval=1, group=bb_group)
bb_dev = input.float(2.0, "BB Deviations", minval=0.1, step=0.1, group=bb_group)
bb_source = input.source(close, "BB Price Source", group=bb_group)

// ========================================
// 3. TRAILING STOP
// ========================================
trail_group = "═══ Trailing Stop ═══"
sl_points_fixed = input.int(300, "Stop Loss Initial (Points)", minval=1, group=trail_group)
use_trailing = input.bool(true, "Activer Trailing Stop", group=trail_group)
trail_activation = input.int(200, "Activation après X points", minval=1, group=trail_group)
trail_offset = input.int(100, "Distance du Suivi", minval=1, group=trail_group)

// ========================================
// 4. PINECONNECTOR ALERTS
// ========================================
alert_group = "═══ PineConnector Alerts ═══"
lot_size = input.float(0.01, "Lot Size", minval=0.01, step=0.01, group=alert_group, tooltip="Taille du lot pour les ordres (exemple: 0.01, 0.1, 1.0)")

// ========================================
// CALCULS INDICATEURS
// ========================================
[bb_middle, bb_upper, bb_lower] = ta.bb(bb_source, bb_period, bb_dev)

// ========================================
// LOGIQUE D'ENTRÉE
// ========================================
bool bb_buy = false
bool bb_sell = false

if bb_strategy == "Sell Above and Buy Below"
    bb_buy := close < bb_lower
    bb_sell := close > bb_upper
else if bb_strategy == "Buy Above and Sell Below"
    bb_buy := close > bb_upper
    bb_sell := close < bb_lower

// Filtrage selon la direction choisie
can_long = trade_direction == "Long Only" or trade_direction == "Both"
can_short = trade_direction == "Short Only" or trade_direction == "Both"

// Conditions finales
final_buy = bb_buy and can_long
final_sell = bb_sell and can_short

// ========================================
// GÉNÉRATION DES MESSAGES D'ALERTE
// ========================================
string alert_message_buy = str.tostring(syminfo.ticker) + ",buy," + str.tostring(lot_size) + "," + str.tostring(close)
string alert_message_sell = str.tostring(syminfo.ticker) + ",sell," + str.tostring(lot_size) + "," + str.tostring(close)
string alert_message_exit = str.tostring(syminfo.ticker) + ",exit," + str.tostring(lot_size) + "," + str.tostring(close)

// ========================================
// EXÉCUTION DES ORDRES
// ========================================
if final_buy and strategy.position_size == 0
    strategy.entry("Buy", strategy.long, alert_message=alert_message_buy)

if final_sell and strategy.position_size == 0
    strategy.entry("Sell", strategy.short, alert_message=alert_message_sell)

// ========================================
// LOGIQUE DE SORTIE (Trailing)
// ========================================
sl_val = sl_points_fixed * syminfo.mintick
if use_trailing
    strategy.exit("Exit Trailing", from_entry="Buy", stop=strategy.position_avg_price - sl_val, trail_points=trail_activation, trail_offset=trail_offset, alert_message=alert_message_exit)
    strategy.exit("Exit Trailing", from_entry="Sell", stop=strategy.position_avg_price + sl_val, trail_points=trail_activation, trail_offset=trail_offset, alert_message=alert_message_exit)
else
    strategy.exit("Exit Fixed", "Buy", stop=strategy.position_avg_price - sl_val, alert_message=alert_message_exit)
    strategy.exit("Exit Fixed", "Sell", stop=strategy.position_avg_price + sl_val, alert_message=alert_message_exit)

// ========================================
// VISUALISATION
// ========================================
// Bollinger Bands
p1 = plot(bb_upper, "BB Upper", color=color.new(color.red, 60))
p2 = plot(bb_lower, "BB Lower", color=color.new(color.green, 60))
p3 = plot(bb_middle, "BB Middle", color=color.new(color.blue, 50), linewidth=1)
fill(p1, p2, color=color.new(color.blue, 95))

// SL Simulation Visuelle
var float visual_sl = na
trail_act_val = trail_activation * syminfo.mintick
trail_off_val = trail_offset * syminfo.mintick

if strategy.position_size > 0 
    initial_sl = strategy.position_avg_price - sl_val
    act_price = strategy.position_avg_price + trail_act_val
    if high > act_price or (not na(visual_sl) and visual_sl > initial_sl)
        new_sl = high - trail_off_val
        visual_sl := na(visual_sl) ? initial_sl : math.max(visual_sl, new_sl)
    else
        visual_sl := initial_sl
else if strategy.position_size < 0
    initial_sl = strategy.position_avg_price + sl_val
    act_price = strategy.position_avg_price - trail_act_val
    if low < act_price or (not na(visual_sl) and visual_sl < initial_sl)
        new_sl = low + trail_off_val
        visual_sl := na(visual_sl) ? initial_sl : math.min(visual_sl, new_sl)
    else
        visual_sl := initial_sl
else
    visual_sl := na

plot(visual_sl, "Trailing SL", color=color.red, style=plot.style_linebr, linewidth=2)
plot(strategy.position_size != 0 ? strategy.position_avg_price : na, "Entry", color=color.gray, style=plot.style_linebr, linewidth=1)